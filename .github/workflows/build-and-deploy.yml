name: hashicorp/field-workshops-nomad/build-and-deploy
on:
  push:
    branches:
    - main
env:
  INSTRUQT_TOKEN: xxxxxxx
  INSTRUQT_VERSION: xxxxxxx
jobs:
  instruqt-validate:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    container:
      image: docker.mirror.hashicorp.services/ubuntu:latest
    steps:
    - uses: actions/checkout@8f4b7f84864484a7bf31766abe9204da3cbe65b3 # v3.5.0
    - name: Run Instruqt Validate
      run: |-
        VERSION=$INSTRUQT_VERSION
        apt -y update
        apt -y install wget unzip
        wget https://github.com/instruqt/cli/releases/download/${VERSION}/instruqt-linux-${VERSION}.zip -O /tmp/instruqt.zip
        cd /tmp
        unzip instruqt.zip
        cp instruqt /usr/local/bin/instruqt
        chmod +x /usr/local/bin/instruqt
        echo "yes" | instruqt version
        RETVAL=$?
        if [[ $RETVAL -ne 0 ]]; then
          echo "Instruqt is not installed correctly."
          exit 1
        else
          echo "Instruqt is installed and updated to most recent version."
        fi
        echo "Running instruqt track validate..."
        for dir in $(ls -d /root/project/instruqt-tracks/*); do
          cd $dir && instruqt track validate
        done
  instruqt-test-nomad-basics:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    container:
      image: docker.mirror.hashicorp.services/ubuntu:latest
    needs:
    - instruqt-validate
    steps:
    - uses: actions/checkout@8f4b7f84864484a7bf31766abe9204da3cbe65b3 # v3.5.0
    - name: Run Instruqt Test
      run: |-
        VERSION=$INSTRUQT_VERSION
        apt -y update
        apt -y install wget unzip
        wget https://github.com/instruqt/cli/releases/download/${VERSION}/instruqt-linux-${VERSION}.zip -O /tmp/instruqt.zip
        cd /tmp
        unzip instruqt.zip
        cp instruqt /usr/local/bin/instruqt
        chmod +x /usr/local/bin/instruqt
        echo "yes" | instruqt version
        RETVAL=$?
        if [[ $RETVAL -ne 0 ]]; then
          echo "Instruqt is not installed correctly."
          exit 1
        else
          echo "Instruqt is installed and updated to most recent version."
        fi
        cd /root/project/instruqt-tracks/nomad-basics
        echo "Running instruqt track push..."
        instruqt track push --force
        echo "Running instruqt track test..."
        # Retry instruqt track test up to 3 times
        n=0
        until [ $n -ge 3 ]
        do
          instruqt track test --skip-fail-check && break
          n=$[$n+1]
          sleep 60
        done
        if [ $n -ge 3 ]; then
          echo "Instruqt track test failed three times."
          exit 1
        fi
  instruqt-test-nomad-simple-cluster:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    container:
      image: docker.mirror.hashicorp.services/ubuntu:latest
    needs:
    - instruqt-validate
    steps:
    - uses: actions/checkout@8f4b7f84864484a7bf31766abe9204da3cbe65b3 # v3.5.0
    - name: Run Instruqt Test
      run: |-
        VERSION=$INSTRUQT_VERSION
        apt -y update
        apt -y install wget unzip
        wget https://github.com/instruqt/cli/releases/download/${VERSION}/instruqt-linux-${VERSION}.zip -O /tmp/instruqt.zip
        cd /tmp
        unzip instruqt.zip
        cp instruqt /usr/local/bin/instruqt
        chmod +x /usr/local/bin/instruqt
        echo "yes" | instruqt version
        RETVAL=$?
        if [[ $RETVAL -ne 0 ]]; then
          echo "Instruqt is not installed correctly."
          exit 1
        else
          echo "Instruqt is installed and updated to most recent version."
        fi
        cd /root/project/instruqt-tracks/nomad-simple-cluster
        echo "Running instruqt track push..."
        instruqt track push --force
        echo "Running instruqt track test..."
        # Retry instruqt track test up to 3 times
        n=0
        until [ $n -ge 3 ]
        do
          instruqt track test --skip-fail-check && break
          n=$[$n+1]
          sleep 60
        done
        if [ $n -ge 3 ]; then
          echo "Instruqt track test failed three times."
          exit 1
        fi
  instruqt-test-nomad-multi-server-cluster:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    container:
      image: docker.mirror.hashicorp.services/ubuntu:latest
    needs:
    - instruqt-validate
    steps:
    - uses: actions/checkout@8f4b7f84864484a7bf31766abe9204da3cbe65b3 # v3.5.0
    - name: Run Instruqt Test
      run: |-
        VERSION=$INSTRUQT_VERSION
        apt -y update
        apt -y install wget unzip
        wget https://github.com/instruqt/cli/releases/download/${VERSION}/instruqt-linux-${VERSION}.zip -O /tmp/instruqt.zip
        cd /tmp
        unzip instruqt.zip
        cp instruqt /usr/local/bin/instruqt
        chmod +x /usr/local/bin/instruqt
        echo "yes" | instruqt version
        RETVAL=$?
        if [[ $RETVAL -ne 0 ]]; then
          echo "Instruqt is not installed correctly."
          exit 1
        else
          echo "Instruqt is installed and updated to most recent version."
        fi
        cd /root/project/instruqt-tracks/nomad-multi-server-cluster
        echo "Running instruqt track push..."
        instruqt track push --force
        echo "Running instruqt track test..."
        # Retry instruqt track test up to 3 times
        n=0
        until [ $n -ge 3 ]
        do
          instruqt track test --skip-fail-check && break
          n=$[$n+1]
          sleep 60
        done
        if [ $n -ge 3 ]; then
          echo "Instruqt track test failed three times."
          exit 1
        fi
  instruqt-test-nomad-consul-connect:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    container:
      image: docker.mirror.hashicorp.services/ubuntu:latest
    needs:
    - instruqt-validate
    steps:
    - uses: actions/checkout@8f4b7f84864484a7bf31766abe9204da3cbe65b3 # v3.5.0
    - name: Run Instruqt Test
      run: |-
        VERSION=$INSTRUQT_VERSION
        apt -y update
        apt -y install wget unzip
        wget https://github.com/instruqt/cli/releases/download/${VERSION}/instruqt-linux-${VERSION}.zip -O /tmp/instruqt.zip
        cd /tmp
        unzip instruqt.zip
        cp instruqt /usr/local/bin/instruqt
        chmod +x /usr/local/bin/instruqt
        echo "yes" | instruqt version
        RETVAL=$?
        if [[ $RETVAL -ne 0 ]]; then
          echo "Instruqt is not installed correctly."
          exit 1
        else
          echo "Instruqt is installed and updated to most recent version."
        fi
        cd /root/project/instruqt-tracks/nomad-consul-connect
        echo "Running instruqt track push..."
        instruqt track push --force
        echo "Running instruqt track test..."
        # Retry instruqt track test up to 3 times
        n=0
        until [ $n -ge 3 ]
        do
          instruqt track test --skip-fail-check && break
          n=$[$n+1]
          sleep 60
        done
        if [ $n -ge 3 ]; then
          echo "Instruqt track test failed three times."
          exit 1
        fi
  instruqt-test-nomad-acls:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    container:
      image: docker.mirror.hashicorp.services/ubuntu:latest
    needs:
    - instruqt-validate
    steps:
    - uses: actions/checkout@8f4b7f84864484a7bf31766abe9204da3cbe65b3 # v3.5.0
    - name: Run Instruqt Test
      run: |-
        VERSION=$INSTRUQT_VERSION
        apt -y update
        apt -y install wget unzip
        wget https://github.com/instruqt/cli/releases/download/${VERSION}/instruqt-linux-${VERSION}.zip -O /tmp/instruqt.zip
        cd /tmp
        unzip instruqt.zip
        cp instruqt /usr/local/bin/instruqt
        chmod +x /usr/local/bin/instruqt
        echo "yes" | instruqt version
        RETVAL=$?
        if [[ $RETVAL -ne 0 ]]; then
          echo "Instruqt is not installed correctly."
          exit 1
        else
          echo "Instruqt is installed and updated to most recent version."
        fi
        cd /root/project/instruqt-tracks/nomad-acls
        echo "Running instruqt track push..."
        instruqt track push --force
        echo "Running instruqt track test..."
        # Retry instruqt track test up to 3 times
        n=0
        until [ $n -ge 3 ]
        do
          instruqt track test --skip-fail-check && break
          n=$[$n+1]
          sleep 60
        done
        if [ $n -ge 3 ]; then
          echo "Instruqt track test failed three times."
          exit 1
        fi
  instruqt-test-nomad-monitoring:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    container:
      image: docker.mirror.hashicorp.services/ubuntu:latest
    needs:
    - instruqt-validate
    steps:
    - uses: actions/checkout@8f4b7f84864484a7bf31766abe9204da3cbe65b3 # v3.5.0
    - name: Run Instruqt Test
      run: |-
        VERSION=$INSTRUQT_VERSION
        apt -y update
        apt -y install wget unzip
        wget https://github.com/instruqt/cli/releases/download/${VERSION}/instruqt-linux-${VERSION}.zip -O /tmp/instruqt.zip
        cd /tmp
        unzip instruqt.zip
        cp instruqt /usr/local/bin/instruqt
        chmod +x /usr/local/bin/instruqt
        echo "yes" | instruqt version
        RETVAL=$?
        if [[ $RETVAL -ne 0 ]]; then
          echo "Instruqt is not installed correctly."
          exit 1
        else
          echo "Instruqt is installed and updated to most recent version."
        fi
        cd /root/project/instruqt-tracks/nomad-monitoring
        echo "Running instruqt track push..."
        instruqt track push --force
        echo "Running instruqt track test..."
        # Retry instruqt track test up to 3 times
        n=0
        until [ $n -ge 3 ]
        do
          instruqt track test --skip-fail-check && break
          n=$[$n+1]
          sleep 60
        done
        if [ $n -ge 3 ]; then
          echo "Instruqt track test failed three times."
          exit 1
        fi
  instruqt-test-nomad-update-strategies:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    container:
      image: docker.mirror.hashicorp.services/ubuntu:latest
    needs:
    - instruqt-validate
    steps:
    - uses: actions/checkout@8f4b7f84864484a7bf31766abe9204da3cbe65b3 # v3.5.0
    - name: Run Instruqt Test
      run: |-
        VERSION=$INSTRUQT_VERSION
        apt -y update
        apt -y install wget unzip
        wget https://github.com/instruqt/cli/releases/download/${VERSION}/instruqt-linux-${VERSION}.zip -O /tmp/instruqt.zip
        cd /tmp
        unzip instruqt.zip
        cp instruqt /usr/local/bin/instruqt
        chmod +x /usr/local/bin/instruqt
        echo "yes" | instruqt version
        RETVAL=$?
        if [[ $RETVAL -ne 0 ]]; then
          echo "Instruqt is not installed correctly."
          exit 1
        else
          echo "Instruqt is installed and updated to most recent version."
        fi
        cd /root/project/instruqt-tracks/nomad-update-strategies
        echo "Running instruqt track push..."
        instruqt track push --force
        echo "Running instruqt track test..."
        # Retry instruqt track test up to 3 times
        n=0
        until [ $n -ge 3 ]
        do
          instruqt track test --skip-fail-check && break
          n=$[$n+1]
          sleep 60
        done
        if [ $n -ge 3 ]; then
          echo "Instruqt track test failed three times."
          exit 1
        fi
  instruqt-test-nomad-job-placement:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    container:
      image: docker.mirror.hashicorp.services/ubuntu:latest
    needs:
    - instruqt-validate
    steps:
    - uses: actions/checkout@8f4b7f84864484a7bf31766abe9204da3cbe65b3 # v3.5.0
    - name: Run Instruqt Test
      run: |-
        VERSION=$INSTRUQT_VERSION
        apt -y update
        apt -y install wget unzip
        wget https://github.com/instruqt/cli/releases/download/${VERSION}/instruqt-linux-${VERSION}.zip -O /tmp/instruqt.zip
        cd /tmp
        unzip instruqt.zip
        cp instruqt /usr/local/bin/instruqt
        chmod +x /usr/local/bin/instruqt
        echo "yes" | instruqt version
        RETVAL=$?
        if [[ $RETVAL -ne 0 ]]; then
          echo "Instruqt is not installed correctly."
          exit 1
        else
          echo "Instruqt is installed and updated to most recent version."
        fi
        cd /root/project/instruqt-tracks/nomad-job-placement
        echo "Running instruqt track push..."
        instruqt track push --force
        echo "Running instruqt track test..."
        # Retry instruqt track test up to 3 times
        n=0
        until [ $n -ge 3 ]
        do
          instruqt track test --skip-fail-check && break
          n=$[$n+1]
          sleep 60
        done
        if [ $n -ge 3 ]; then
          echo "Instruqt track test failed three times."
          exit 1
        fi
  instruqt-test-nomad-integration-with-vault:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    container:
      image: docker.mirror.hashicorp.services/ubuntu:latest
    needs:
    - instruqt-validate
    steps:
    - uses: actions/checkout@8f4b7f84864484a7bf31766abe9204da3cbe65b3 # v3.5.0
    - name: Run Instruqt Test
      run: |-
        VERSION=$INSTRUQT_VERSION
        apt -y update
        apt -y install wget unzip
        wget https://github.com/instruqt/cli/releases/download/${VERSION}/instruqt-linux-${VERSION}.zip -O /tmp/instruqt.zip
        cd /tmp
        unzip instruqt.zip
        cp instruqt /usr/local/bin/instruqt
        chmod +x /usr/local/bin/instruqt
        echo "yes" | instruqt version
        RETVAL=$?
        if [[ $RETVAL -ne 0 ]]; then
          echo "Instruqt is not installed correctly."
          exit 1
        else
          echo "Instruqt is installed and updated to most recent version."
        fi
        cd /root/project/instruqt-tracks/nomad-integration-with-vault
        echo "Running instruqt track push..."
        instruqt track push --force
        echo "Running instruqt track test..."
        # Retry instruqt track test up to 3 times
        n=0
        until [ $n -ge 3 ]
        do
          instruqt track test --skip-fail-check && break
          n=$[$n+1]
          sleep 60
        done
        if [ $n -ge 3 ]; then
          echo "Instruqt track test failed three times."
          exit 1
        fi
  instruqt-test-nomad-host-volumes:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    container:
      image: docker.mirror.hashicorp.services/ubuntu:latest
    needs:
    - instruqt-validate
    steps:
    - uses: actions/checkout@8f4b7f84864484a7bf31766abe9204da3cbe65b3 # v3.5.0
    - name: Run Instruqt Test
      run: |-
        VERSION=$INSTRUQT_VERSION
        apt -y update
        apt -y install wget unzip
        wget https://github.com/instruqt/cli/releases/download/${VERSION}/instruqt-linux-${VERSION}.zip -O /tmp/instruqt.zip
        cd /tmp
        unzip instruqt.zip
        cp instruqt /usr/local/bin/instruqt
        chmod +x /usr/local/bin/instruqt
        echo "yes" | instruqt version
        RETVAL=$?
        if [[ $RETVAL -ne 0 ]]; then
          echo "Instruqt is not installed correctly."
          exit 1
        else
          echo "Instruqt is installed and updated to most recent version."
        fi
        cd /root/project/instruqt-tracks/nomad-host-volumes
        echo "Running instruqt track push..."
        instruqt track push --force
        echo "Running instruqt track test..."
        # Retry instruqt track test up to 3 times
        n=0
        until [ $n -ge 3 ]
        do
          instruqt track test --skip-fail-check && break
          n=$[$n+1]
          sleep 60
        done
        if [ $n -ge 3 ]; then
          echo "Instruqt track test failed three times."
          exit 1
        fi
  instruqt-test-nomad-and-portworx:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    container:
      image: ubuntu:latest
    needs:
    - instruqt-validate
    steps:
    - uses: actions/checkout@8f4b7f84864484a7bf31766abe9204da3cbe65b3 # v3.5.0
    - name: Run Instruqt Test
      run: |-
        VERSION=$INSTRUQT_VERSION
        apt -y update
        apt -y install wget unzip
        wget https://github.com/instruqt/cli/releases/download/${VERSION}/instruqt-linux-${VERSION}.zip -O /tmp/instruqt.zip
        cd /tmp
        unzip instruqt.zip
        cp instruqt /usr/local/bin/instruqt
        chmod +x /usr/local/bin/instruqt
        echo "yes" | instruqt version
        RETVAL=$?
        if [[ $RETVAL -ne 0 ]]; then
          echo "Instruqt is not installed correctly."
          exit 1
        else
          echo "Instruqt is installed and updated to most recent version."
        fi
        cd /root/project/instruqt-tracks/nomad-and-portworx
        echo "Running instruqt track push..."
        instruqt track push --force
        echo "Running instruqt track test..."
        # Retry instruqt track test up to 3 times
        n=0
        until [ $n -ge 3 ]
        do
          instruqt track test --skip-fail-check && break
          n=$[$n+1]
          sleep 60
        done
        if [ $n -ge 3 ]; then
          echo "Instruqt track test failed three times."
          exit 1
        fi
  instruqt-test-nomad-csi-plugins-gcp:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    container:
      image: docker.mirror.hashicorp.services/ubuntu:latest
    needs:
    - instruqt-validate
    steps:
    - uses: actions/checkout@8f4b7f84864484a7bf31766abe9204da3cbe65b3 # v3.5.0
    - name: Run Instruqt Test
      run: |-
        VERSION=$INSTRUQT_VERSION
        apt -y update
        apt -y install wget unzip
        wget https://github.com/instruqt/cli/releases/download/${VERSION}/instruqt-linux-${VERSION}.zip -O /tmp/instruqt.zip
        cd /tmp
        unzip instruqt.zip
        cp instruqt /usr/local/bin/instruqt
        chmod +x /usr/local/bin/instruqt
        echo "yes" | instruqt version
        RETVAL=$?
        if [[ $RETVAL -ne 0 ]]; then
          echo "Instruqt is not installed correctly."
          exit 1
        else
          echo "Instruqt is installed and updated to most recent version."
        fi
        cd /root/project/instruqt-tracks/nomad-and-csi-plugins-gcp
        echo "Running instruqt track push..."
        instruqt track push --force
        echo "Running instruqt track test..."
        # Retry instruqt track test up to 3 times
        n=0
        until [ $n -ge 3 ]
        do
          instruqt track test --skip-fail-check && break
          n=$[$n+1]
          sleep 60
        done
        if [ $n -ge 3 ]; then
          echo "Instruqt track test failed three times."
          exit 1
        fi
  instruqt-test-nomad-governance:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    container:
      image: docker.mirror.hashicorp.services/ubuntu:latest
    needs:
    - instruqt-validate
    steps:
    - uses: actions/checkout@8f4b7f84864484a7bf31766abe9204da3cbe65b3 # v3.5.0
    - name: Run Instruqt Test
      run: |-
        VERSION=$INSTRUQT_VERSION
        apt -y update
        apt -y install wget unzip
        wget https://github.com/instruqt/cli/releases/download/${VERSION}/instruqt-linux-${VERSION}.zip -O /tmp/instruqt.zip
        cd /tmp
        unzip instruqt.zip
        cp instruqt /usr/local/bin/instruqt
        chmod +x /usr/local/bin/instruqt
        echo "yes" | instruqt version
        RETVAL=$?
        if [[ $RETVAL -ne 0 ]]; then
          echo "Instruqt is not installed correctly."
          exit 1
        else
          echo "Instruqt is installed and updated to most recent version."
        fi
        cd /root/project/instruqt-tracks/nomad-governance
        echo "Running instruqt track push..."
        instruqt track push --force
        echo "Running instruqt track test..."
        # Retry instruqt track test up to 3 times
        n=0
        until [ $n -ge 3 ]
        do
          instruqt track test --skip-fail-check && break
          n=$[$n+1]
          sleep 60
        done
        if [ $n -ge 3 ]; then
          echo "Instruqt track test failed three times."
          exit 1
        fi
  instruqt-test-nomad-federation:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    container:
      image: docker.mirror.hashicorp.services/ubuntu:latest
    needs:
    - instruqt-validate
    steps:
    - uses: actions/checkout@8f4b7f84864484a7bf31766abe9204da3cbe65b3 # v3.5.0
    - name: Run Instruqt Test
      run: |-
        VERSION=$INSTRUQT_VERSION
        apt -y update
        apt -y install wget unzip
        wget https://github.com/instruqt/cli/releases/download/${VERSION}/instruqt-linux-${VERSION}.zip -O /tmp/instruqt.zip
        cd /tmp
        unzip instruqt.zip
        cp instruqt /usr/local/bin/instruqt
        chmod +x /usr/local/bin/instruqt
        echo "yes" | instruqt version
        RETVAL=$?
        if [[ $RETVAL -ne 0 ]]; then
          echo "Instruqt is not installed correctly."
          exit 1
        else
          echo "Instruqt is installed and updated to most recent version."
        fi
        cd /root/project/instruqt-tracks/nomad-multi-region-federation
        echo "Running instruqt track push..."
        instruqt track push --force
        echo "Running instruqt track test..."
        # Retry instruqt track test up to 3 times
        n=0
        until [ $n -ge 3 ]
        do
          instruqt track test --skip-fail-check && break
          n=$[$n+1]
          sleep 60
        done
        if [ $n -ge 3 ]; then
          echo "Instruqt track test failed three times."
          exit 1
        fi
